# aggregate_4

This module provides a workflow for standardizing and aggregating single-cell phenotypic data into gene-level measurements. It performs feature transformations, standardization, and generates montages for visual validation.

## Contents

1. `aggregate_4_smk_test.ipynb`: Jupyter notebook for testing feature processing and aggregation for a small subset of data
2. `aggregate_4.smk`: Main Snakemake file for feature processing and aggregation
3. `aggregate_4.sh`: Bash script to execute the complete workflow
4. `aggregate_4_eval.py`: Python script for generating quality control plots and validating the transformed data
5. `transformations.csv`: Configuration file specifying feature-specific transformations

## Usage

1. `aggregate_4_smk_test.ipynb`: Jupyter notebook for testing data processing parameters and visualizing results, including:
   - Setting population features and control parameters
   - Testing feature transformations
   - Visualizing mitotic/interphase cell separation
   - Generating and evaluating montages
   - Validating gene-level aggregation

2. Run aggregation workflow:
   - Adjust the parameters in `aggregate_4.smk` based on your specific setup and requirements
   - Execute `aggregate_4.sh` to run the Snakemake workflow

3. Evaluate results:
   - Run `aggregate_4_eval.py`, which generates quality control plots for the transformed features and tests for missing values in the final datasets

## Key Features

- Applies feature-specific transformations to normalize distributions
- Standardizes features across the dataset
- Splits data into mitotic and interphase populations
- Generates gene-level statistics
- Creates montages for visual validation
- Produces quality control plots and statistics

## Dependencies

- Python libraries: numpy, pandas, matplotlib, seaborn
- ops package modules:
  - ops.aggregate: For feature processing and aggregation functions
  - ops.process: For data transformation utilities
  - ops.qc: For quality control functions

## Notes

Given different formats of saving data in either a well based (single or multichannel) or tile based (multichannel) format, we provide example analysis for the two respective cases. For this step, there is no difference in these workflows.

- The workflow processes three main populations:
  - All cells combined
  - Mitotic cells
  - Interphase cells
- Feature transformations are crucial for:
  - Normalizing skewed distributions
  - Enabling proper standardization
  - Ensuring valid statistical comparisons
- Montages are generated for visual validation of phenotypes
- Before running the full workflow, it is recommended to test the pipeline on these initial alignments using `aggregate_4_smk_test.ipynb`.

## File structure for running

```
plate/
├── aggregate_4.smk
├── merge_3/
│   └── hdf/
│       └── merged_final.hdf
└── aggregate_4/
│   ├── aggregate_4.sh
│   ├── aggregate_4_eval.py
│   ├── transformations.csv
│   ├── hdf/*
│   │   ├── transformed_data.hdf
│   │   └── standardized_data.hdf
│   ├── csv/*
│   │   ├── all_gene_data.csv
│   │   ├── mitotic_gene_data.csv
│   │   └── interphase_gene_data.csv
│   └── qc/*
└── montage/*
```

Directories marked with an asterisk contain files generated by this workflow.

Note: 
- Ensure that your input files from the merge_3 step are present in `merge_3/hdf` before running the workflow
- The workflow generates:
  - Transformed and standardized data in `aggregate_4/hdf/`
  - Gene-level statistics in `aggregate_4/csv/`
  - Quality control plots in `aggregate_4/qc/`
  - Visual validation montages in `montage/`

Maintaining this file structure is crucial for the correct execution of the workflow. Any changes to the structure may require corresponding adjustments in the scripts.