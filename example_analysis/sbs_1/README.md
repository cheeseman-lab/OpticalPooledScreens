# sbs_1

This module provides a workflow for processing Sequencing By Synthesis (SBS) microscopy files, generating metadata, and performing read calling and cell assignment. It is designed to handle SBS acquisitions and integrate with the previous preprocessing step.

## Contents

1. `sbs_1_smk_test.ipynb`: Python script for ensuring correct SBS image loading and processing at the tile level.
2. `sbs_1.sh`: Bash script to execute the Snakemake workflow.
3. `sbs_1.smk`: Main Snakemake file that includes rules for SBS image processing, base calling, and cell assignment.
4. `sbs_1_eval.py`: Python script for evaluating SBS results and generating quality control plots.

## Usage

1. Test input patterns and processing:
   - Run `sbs_1_smk_test.ipynb` to ensure SBS images are loaded and processed correctly.
   - Modify the input patterns, channels, and other parameters as needed for your specific setup.

2. Run SBS processing workflow:
   - Adjust the parameters in `sbs_1.smk` based on the results from `sbs_1_smk_test.ipynb`.
   - Execute `sbs_1.sh` to run the Snakemake workflow.

3. Evaluate results:
   - Run `sbs_1_eval.py` to generate quality control plots and statistics for the SBS processing results.

## Key Features

- Aligns SBS images across cycles
- Performs illumination correction
- Segments cells and nuclei
- Extracts base intensities and calls reads
- Assigns reads to cells
- Generates quality control plots and statistics

## Dependencies

- Python libraries: numpy, pandas, matplotlib, seaborn, tifffile
- ops package modules:
  - ops.firesnake: For specific SBS processing functions used in the Snakemake workflow
      - ops.annotate: For data annotation
      - ops.in_situ: For in situ sequencing analysis
      - ops.cellpose: For cell segmentation using Cellpose
      - ops.process: For image processing operations
>>>>>>> Stashed changes
  - ops.qc: For quality control functions

## Notes

Given different formats of saving data in either a well based (single or multichannel) or tile based (multichannel) format, we provide example analysis for the two respective cases. These workflows differ largely only their alignment and image correction step.

- Ensure all paths and parameters are correctly set in the Snakemake and Python files before running the workflow.
- The evaluation step is crucial to confirm the quality and correctness of the SBS processing results.
- Before running the full workflow, it is recommended to test the pipeline on a single well or cycle using `sbs_1_smk_test.ipynb`.

## File structure for running

```
plate/
├── sbs_1.smk
├── input_sbs_tif/
├── sbs_1/
│   ├── barcodes.csv
│   ├── sbs_1_smk_test.ipynb
│   ├── sbs_1.sh
│   ├── sbs_1_eval.py
│   ├── sbs_1_eval.sh
│   ├── csv/*
│   ├── tif/*
│   ├── hdf/*
│   └── qc/*
└── process_sbs/
   ├── images/*
   └── tables/*
```

Directories marked with an asterisk contain files generated by this workflow.

Note: 
- Ensure that your input TIFF files from the preprocessing step are in the `input_sbs_tif/` and `illumination_correction/` directories before running the workflow.
- The test workflow will generate example output files for one tile in the `sbs_1/csv/`, `sbs_1/tif/` directories.
- The full snakemake run will generate output files in `process_sbs/images/` and `process_sbs/tables/` directories.
- The evaluation step will generate output files in `sbs_1/hdf/` and `sbs_1/qc/` directories.
- Maintaining this file structure is crucial for the correct execution of the workflow. Any changes to the structure may require corresponding adjustments in the scripts.