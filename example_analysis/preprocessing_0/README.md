# preprocessing_0

This module provides a workflow for preprocessing ND2 microscopy files, generating metadata, and creating image correction files. It is designed to handle both Sequential-Based Sequencing (SBS) and Phenotype (PH) acquisitions.

## Contents

1. `preprocessing_smk_test.ipynb`: Jupyter notebook for testing well-based image patterns and ensuring correct image loading.
2. `preprocessing_0.sh`: Bash script to execute the Snakemake workflow.
3. `preprocessing_0.smk`: Main Snakemake file that includes both tile-based and well-based preprocessing rules.
4. `preprocessing_0_eval.ipynb`: Jupyter notebook for evaluating preprocessing results and checking metadata correspondence between PH and SBS images.

## Usage

1. Test input patterns:
   - Open `preprocessing_smk_test.ipynb` in Jupyter Lab or Notebook.
   - Modify the input patterns and channel for your ND2 files.
   - Run the notebook to ensure images are loaded correctly.

2. Run preprocessing workflow:
   - Adjust the patterns, channels, and other parameters in `preprocessing_0.smk` based on `preprocessing_smk_test.ipynb`.
   - Execute `preprocessing_0.sh` to run the Snakemake workflow.

3. Evaluate results:
   - Open `preprocessing_0_eval.ipynb` in Jupyter Lab or Notebook.
   - Run the notebook to check if the generated images look correct and if the metadata corresponds between PH and SBS acquisitions.

## Key Features

- Converts ND2 files to TIFF format
- Generates metadata for SBS and PH images
- Creates illumination correction files
- Supports both tile-based and well-based processing approaches

## Dependencies

- Python libraries: numpy, pandas, matplotlib, seaborn, tifffile, microfilm
- Snakemake
- ImageJ (for some TIFF operations)
- ops package modules:
  - ops.preprocessing_smk: For specific preprocessing functions used in the Snakemake workflow
  - ops.filenames: For handling file naming conventions
  - ops.process: For image processing functions, including calculate_illumination_correction
  - ops.io: For input/output operations, including save_stack

## Notes

Given different formats of saving data in either a well based (single or multichannel) or tile based (multichannel) format, we provide example analysis for the two respective cases. These workflows will create different output tiff files that preserve the original channel based nature of the input nd2 images, to facilitate the alignment step in sbs_1 and ph_2. 

- Ensure all paths and parameters are correctly set in the Snakemake files before running the workflow.
- The evaluation step is crucial to confirm the quality and correctness of the preprocessing results before moving onwards.
- Before running the full workflow, it is recommended to test the Snakemake pipeline on a single well or cycle. This can be done by modifying the input patterns or limiting the WELLS or CYCLES variables in the Snakemake files. Once you've confirmed that the workflow runs correctly on a limited dataset, you can proceed with the full preprocessing.

For more detailed information on each step, please refer to the individual files and their comments.

## File structure for running

plate/
├── preprocessing_0.smk
├── input_sbs/
├── input_ph/
├── input_ph_tif/*
├── input_sbs_tif/*
├── metadata/*
├── illumination_correction/*
└── preprocessing_0/
    ├── preprocessing_0_eval.ipynb
    ├── preprocessing_0.sh
    └── preprocessing_smk_test.ipynb
    
Directories marked with an asterisk (*) contain files generated by this workflow.

Note: 
- Ensure that your input ND2 files are placed in the appropriate `input_sbs/` and `input_ph/` directories before running the workflow.
- The workflow will generate output files in the `input_ph_tif/`, `input_sbs_tif/`, `metadata/`, and `illumination_correction/` directories.
- All preprocessing scripts and notebooks should be placed in the `preprocessing_0/` directory.
- Maintaining this file structure is crucial for the correct execution of the workflow. Any changes to the structure may require corresponding adjustments in the scripts.
